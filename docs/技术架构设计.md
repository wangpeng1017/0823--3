# 飞书合同内容更新助手 - 技术架构设计文档

## 1. 项目概述

### 1.1 项目目标
开发一款Web应用，通过飞书云文档MCP集成，实现合同文档的自动化内容更新，支持自定义指令和OCR截图识别两种更新方式。

### 1.2 核心功能
- 飞书OAuth 2.0用户认证
- 飞书云文档读取和写入
- 基于规则的文本查找替换
- OCR图片文字识别和智能解析
- 用户友好的Web界面

## 2. 技术选型

### 2.1 前端技术栈
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **UI组件**: Headless UI / Radix UI
- **状态管理**: Zustand
- **表单处理**: React Hook Form + Zod
- **HTTP客户端**: Axios

### 2.2 后端技术栈
- **运行时**: Node.js (Vercel Serverless Functions)
- **API框架**: Next.js API Routes
- **数据库**: Vercel Postgres
- **文件存储**: Vercel Blob
- **缓存**: Vercel KV (Redis)

### 2.3 第三方服务
- **认证**: 飞书开放平台 OAuth 2.0
- **文档API**: 飞书云文档 API
- **OCR服务**: Tesseract.js (客户端) + 百度OCR API (服务端)
- **部署平台**: Vercel

## 3. 系统架构

### 3.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户浏览器     │    │   Next.js应用    │    │   飞书开放平台   │
│                │    │                │    │                │
│  - React组件    │◄──►│  - API Routes   │◄──►│  - OAuth 2.0   │
│  - 状态管理     │    │  - 服务层       │    │  - 文档API      │
│  - 表单验证     │    │  - 数据层       │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   数据存储层     │
                    │                │
                    │ - Vercel Postgres│
                    │ - Vercel Blob   │
                    │ - Vercel KV     │
                    └─────────────────┘
```

### 3.2 核心模块设计

#### 3.2.1 认证模块 (Auth Module)
- **OAuth服务**: 处理飞书OAuth 2.0认证流程
- **Token管理**: access_token的获取、存储、刷新
- **会话管理**: 用户会话状态维护

#### 3.2.2 文档处理模块 (Document Module)
- **URL解析**: 飞书文档链接解析和验证
- **API封装**: 飞书文档API调用封装
- **内容处理**: 文档内容的结构化处理

#### 3.2.3 文本处理模块 (Text Processing Module)
- **查找算法**: 高效的文本查找实现
- **替换引擎**: 批量文本替换处理
- **结果验证**: 替换操作的验证和回滚

#### 3.2.4 OCR模块 (OCR Module)
- **图片处理**: 图片预处理和优化
- **文字识别**: OCR文字识别服务
- **智能解析**: 结构化信息提取

#### 3.2.5 存储模块 (Storage Module)
- **用户数据**: 用户信息和授权数据
- **文件存储**: 上传图片的安全存储
- **操作日志**: 操作记录和审计日志

## 4. 数据流设计

### 4.1 用户认证流程
```
用户 → 点击登录 → 重定向到飞书OAuth → 用户授权 → 
回调处理 → 获取access_token → 存储用户信息 → 登录成功
```

### 4.2 文档更新流程（自定义指令）
```
用户输入文档链接 → 验证链接有效性 → 获取文档内容 → 
用户设置替换规则 → 执行文本查找替换 → 更新文档 → 返回结果
```

### 4.3 文档更新流程（OCR截图）
```
用户上传截图 → 图片存储 → OCR文字识别 → 智能信息提取 → 
生成替换规则 → 执行文本替换 → 更新文档 → 返回结果
```

## 5. API设计

### 5.1 认证相关API
- `GET /api/auth/feishu` - 获取飞书OAuth授权链接
- `GET /api/auth/callback` - 处理OAuth回调
- `POST /api/auth/refresh` - 刷新access_token
- `DELETE /api/auth/logout` - 用户登出

### 5.2 文档相关API
- `POST /api/document/parse` - 解析文档链接
- `GET /api/document/content` - 获取文档内容
- `POST /api/document/update` - 更新文档内容

### 5.3 文本处理API
- `POST /api/text/replace` - 执行文本替换
- `POST /api/text/preview` - 预览替换结果

### 5.4 OCR相关API
- `POST /api/ocr/upload` - 上传图片
- `POST /api/ocr/recognize` - 执行OCR识别
- `POST /api/ocr/parse` - 解析识别结果

## 6. 数据库设计

### 6.1 用户表 (users)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  feishu_user_id VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 授权表 (auth_tokens)
```sql
CREATE TABLE auth_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  access_token TEXT NOT NULL,
  refresh_token TEXT,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.3 操作日志表 (operation_logs)
```sql
CREATE TABLE operation_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  document_id VARCHAR(255) NOT NULL,
  operation_type VARCHAR(50) NOT NULL,
  details JSONB,
  status VARCHAR(20) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 7. 安全考虑

### 7.1 数据安全
- 敏感数据加密存储（AES-256）
- access_token安全管理
- 环境变量管理敏感配置

### 7.2 访问控制
- 用户权限验证
- API访问频率限制
- 文档访问权限检查

### 7.3 数据传输
- HTTPS强制加密
- API请求签名验证
- 跨域请求控制

## 8. 性能优化

### 8.1 前端优化
- 组件懒加载
- 图片压缩和优化
- 缓存策略

### 8.2 后端优化
- API响应缓存
- 数据库查询优化
- 异步处理耗时操作

### 8.3 部署优化
- CDN加速
- 服务端渲染优化
- 静态资源压缩

## 9. 开发规范

### 9.1 代码规范
- ESLint + Prettier代码格式化
- TypeScript严格模式
- Git提交规范

### 9.2 测试策略
- 单元测试（Jest）
- 集成测试（Playwright）
- API测试（Postman/Newman）

### 9.3 文档规范
- API文档（OpenAPI）
- 组件文档（Storybook）
- 部署文档

## 10. 部署架构

### 10.1 Vercel部署配置
```json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "installCommand": "npm install",
  "devCommand": "npm run dev"
}
```

### 10.2 环境变量配置
- `FEISHU_APP_ID` - 飞书应用ID
- `FEISHU_APP_SECRET` - 飞书应用密钥
- `DATABASE_URL` - 数据库连接字符串
- `BLOB_READ_WRITE_TOKEN` - Blob存储访问令牌
- `ENCRYPTION_KEY` - 数据加密密钥

### 10.3 CI/CD流程
1. 代码提交到GitHub
2. 自动触发Vercel构建
3. 运行测试用例
4. 部署到预览环境
5. 手动部署到生产环境

这个技术架构设计为项目的开发提供了清晰的指导方向，确保了系统的可扩展性、安全性和性能。
