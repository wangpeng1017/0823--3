# 🔧 环境变量配置完整指南

## 📊 当前配置状态

### ✅ 已配置变量（9个）
```bash
FEISHU_APP_ID=cli_a8223aa97ffad013          # 飞书应用ID
FEISHU_APP_SECRET=buUtzUTcwsSrj4k9IB4zLeyb1g3rO4Fp  # 飞书应用密钥
FEISHU_REDIRECT_URI=http://localhost:3000/api/auth/callback  # OAuth回调地址
ENCRYPTION_KEY=a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456  # 数据加密密钥
JWT_SECRET=Kv8+7X2mR9pL3nQ5wE8tY6uI0oP1aS2dF4gH7jK9lM=  # JWT签名密钥
GOOGLE_API_KEY=AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  # Google Gemini API
GEMINI_MODEL=gemini-1.5-flash               # Gemini模型版本
NEXT_PUBLIC_APP_URL=http://localhost:3000   # 应用访问地址
NODE_ENV=development                        # 运行环境
```

### ❌ 未配置变量（按优先级排序）

## 🔴 高优先级（立即需要）

### 1. BLOB_READ_WRITE_TOKEN
**用途**: 存储OCR上传的图片文件
**影响**: OCR功能无法正常工作
**获取步骤**:

1. **访问Vercel控制台**
   ```
   https://vercel.com/dashboard
   ```

2. **选择项目**
   - 找到 `feishu-contract-helper` 项目
   - 点击进入项目详情

3. **创建Blob存储**
   ```
   导航: Storage → Create Database → Blob
   ```
   - Store Name: `feishu-contract-files`
   - Region: `Washington, D.C., USA (iad1)`

4. **获取令牌**
   - 创建完成后复制 `BLOB_READ_WRITE_TOKEN`
   - 格式: `vercel_blob_rw_xxxxxxxxxx`

5. **配置到环境变量**
   ```bash
   BLOB_READ_WRITE_TOKEN=vercel_blob_rw_your_actual_token
   ```

### 2. DATABASE_URL
**用途**: 存储用户数据、操作历史
**影响**: 用户登录状态、数据持久化功能
**获取步骤**:

1. **创建PostgreSQL数据库**
   ```
   导航: Vercel项目 → Storage → Create Database → Postgres
   ```
   - Database Name: `feishu-contract-db`
   - Region: `Washington, D.C., USA (iad1)`

2. **自动生成连接字符串**
   Vercel会自动生成以下变量：
   ```bash
   DATABASE_URL=postgres://username:password@host:port/database
   POSTGRES_PRISMA_URL=postgres://username:password@host:port/database?pgbouncer=true&connect_timeout=15
   POSTGRES_URL_NON_POOLING=postgres://username:password@host:port/database
   ```

3. **复制到本地环境**
   - 在Vercel项目设置中查看: `Settings → Environment Variables`
   - 复制实际值到 `.env.local`

## 🟡 中优先级（推荐配置）

### 3. KV_REST_API_URL & KV_REST_API_TOKEN
**用途**: Redis缓存，提升应用性能
**影响**: 响应速度和用户体验
**获取步骤**:

1. **创建KV数据库**
   ```
   导航: Vercel项目 → Storage → Create Database → KV
   ```
   - Database Name: `feishu-contract-kv`
   - Region: `Washington, D.C., USA (iad1)`

2. **获取连接信息**
   ```bash
   KV_REST_API_URL=https://your-kv-database.kv.vercel-storage.com
   KV_REST_API_TOKEN=your_kv_token_here
   ```

## 🟢 低优先级（可选配置）

### 4. 百度OCR备用服务
**用途**: 作为Google Gemini的备用OCR服务
**获取步骤**:

1. **访问百度智能云**
   ```
   https://cloud.baidu.com/
   ```

2. **创建文字识别应用**
   ```
   导航: 控制台 → 人工智能 → 文字识别 → 创建应用
   ```

3. **获取API密钥**
   ```bash
   BAIDU_OCR_API_KEY=your_api_key
   BAIDU_OCR_SECRET_KEY=your_secret_key
   ```

## 🔧 配置验证

### 运行验证脚本
```bash
# 检查所有环境变量配置状态
npm run validate-env

# 完整的项目配置验证
npm run validate-setup
```

### 验证输出示例
```
🔍 飞书合同内容更新助手 - 环境变量完整性检查

🔴 关键变量（应用无法运行）:
✅ FEISHU_APP_ID: 配置正确
✅ FEISHU_APP_SECRET: 配置正确
✅ ENCRYPTION_KEY: 配置正确
✅ JWT_SECRET: 配置正确
✅ GOOGLE_API_KEY: 配置正确

🟠 高优先级（核心功能）:
❌ DATABASE_URL: 未配置
❌ BLOB_READ_WRITE_TOKEN: 未配置

📊 配置完成度: 62%
```

## 📋 配置检查清单

### 立即配置（开发阶段）
- [ ] **BLOB_READ_WRITE_TOKEN** - OCR图片上传必需
- [ ] **DATABASE_URL** - 数据存储必需

### 生产部署前配置
- [ ] **KV_REST_API_URL** - 缓存服务
- [ ] **KV_REST_API_TOKEN** - 缓存访问令牌
- [ ] **POSTGRES_PRISMA_URL** - ORM连接
- [ ] **POSTGRES_URL_NON_POOLING** - 数据库迁移

### 可选增强功能
- [ ] **BAIDU_OCR_API_KEY** - 备用OCR服务
- [ ] **BAIDU_OCR_SECRET_KEY** - 备用OCR密钥
- [ ] **SENTRY_DSN** - 错误监控
- [ ] **ANALYTICS_ID** - 用户分析

## 🚨 常见问题

### Q1: Vercel存储服务创建失败
**解决方案**:
1. 确认Vercel账号已验证
2. 检查项目是否已正确部署
3. 尝试刷新页面重新创建

### Q2: 数据库连接字符串格式错误
**解决方案**:
1. 确保复制完整的连接字符串
2. 检查是否包含特殊字符需要URL编码
3. 验证数据库服务状态正常

### Q3: API密钥格式验证失败
**解决方案**:
1. 检查密钥是否完整复制
2. 确认没有多余的空格或换行符
3. 重新生成密钥并替换

## 🎯 配置优先级建议

### 第一阶段（基础功能）
1. 配置 `BLOB_READ_WRITE_TOKEN` - 启用OCR功能
2. 配置 `DATABASE_URL` - 启用数据存储

### 第二阶段（性能优化）
3. 配置 `KV_REST_API_URL/TOKEN` - 启用缓存
4. 配置 `POSTGRES_PRISMA_URL` - 优化数据库连接

### 第三阶段（增强功能）
5. 配置备用OCR服务 - 提高可靠性
6. 配置监控服务 - 生产环境必需

## 📖 相关文档

- [Vercel存储服务文档](https://vercel.com/docs/storage)
- [飞书开放平台文档](https://open.feishu.cn/document/)
- [Google AI Studio文档](https://ai.google.dev/)
- [百度智能云文档](https://cloud.baidu.com/doc/)

---

**注意**: 配置完成后，请运行 `npm run validate-env` 验证所有变量配置正确。
