# 环境变量配置指南

本文档详细说明了飞书合同内容更新助手项目所需的所有环境变量配置。

## 📋 环境变量清单

### 🔴 必需配置（应用无法启动如果缺少）

#### 飞书开放平台配置
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `FEISHU_APP_ID` | ✅ 必需 | 飞书应用ID | 飞书开放平台创建应用后获取 |
| `FEISHU_APP_SECRET` | ✅ 必需 | 飞书应用密钥 | 飞书开放平台应用详情页 |
| `FEISHU_REDIRECT_URI` | ✅ 必需 | OAuth回调地址 | 手动设置，格式：`https://域名/api/auth/callback` |

#### 应用基础配置
| 变量名 | 必需性 | 说明 | 示例值 |
|--------|--------|------|--------|
| `NEXT_PUBLIC_APP_URL` | ✅ 必需 | 应用访问地址 | `http://localhost:3000` (开发) / `https://your-app.vercel.app` (生产) |
| `NODE_ENV` | ✅ 必需 | 运行环境 | `development` / `production` |

#### 数据加密配置
| 变量名 | 必需性 | 说明 | 生成方式 |
|--------|--------|------|----------|
| `ENCRYPTION_KEY` | ✅ 必需 | 数据加密密钥(32字符) | `openssl rand -hex 32` |
| `JWT_SECRET` | ✅ 必需 | JWT签名密钥(最少32字符) | `openssl rand -base64 32` |

### 🟡 生产环境必需配置

#### 数据库配置
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `DATABASE_URL` | 🟡 生产必需 | PostgreSQL连接字符串 | Vercel控制台 -> Storage -> Postgres |
| `POSTGRES_PRISMA_URL` | 🟡 生产必需 | Prisma连接字符串 | Vercel自动生成 |
| `POSTGRES_URL_NON_POOLING` | 🟡 生产必需 | 非池化连接字符串 | Vercel自动生成 |

#### 缓存配置
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `KV_REST_API_URL` | 🟡 推荐 | Redis缓存API地址 | Vercel控制台 -> Storage -> KV |
| `KV_REST_API_TOKEN` | 🟡 推荐 | Redis缓存访问令牌 | Vercel自动生成 |

#### 文件存储配置
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `BLOB_READ_WRITE_TOKEN` | 🟡 OCR功能必需 | Blob存储访问令牌 | Vercel控制台 -> Storage -> Blob |

### 🔵 OCR服务配置（选择其一）

#### 选项1: Google Gemini Vision API（推荐）
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `GOOGLE_API_KEY` | 🔵 可选 | Google API密钥 | Google AI Studio |
| `GEMINI_MODEL` | 🔵 可选 | Gemini模型名称 | 默认：`gemini-1.5-flash` |

#### 选项2: 百度OCR API
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `BAIDU_OCR_API_KEY` | 🔵 可选 | 百度OCR API Key | 百度智能云控制台 |
| `BAIDU_OCR_SECRET_KEY` | 🔵 可选 | 百度OCR Secret Key | 百度智能云控制台 |

#### 选项3: Google Cloud Vision API
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `GOOGLE_CLOUD_PROJECT_ID` | 🔵 可选 | GCP项目ID | Google Cloud Console |
| `GOOGLE_CLOUD_PRIVATE_KEY` | 🔵 可选 | 服务账号私钥 | GCP服务账号JSON |
| `GOOGLE_CLOUD_CLIENT_EMAIL` | 🔵 可选 | 服务账号邮箱 | GCP服务账号JSON |

#### 选项4: Azure Computer Vision
| 变量名 | 必需性 | 说明 | 获取方式 |
|--------|--------|------|----------|
| `AZURE_COMPUTER_VISION_ENDPOINT` | 🔵 可选 | Azure认知服务端点 | Azure Portal |
| `AZURE_COMPUTER_VISION_KEY` | 🔵 可选 | Azure认知服务密钥 | Azure Portal |

### ⚪ 可选配置（增强功能）

#### 性能和安全配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `MAX_FILE_SIZE` | `10485760` | 最大文件大小(字节) |
| `REQUEST_TIMEOUT` | `30000` | 请求超时时间(毫秒) |
| `RATE_LIMIT_MAX` | `100` | 速率限制最大请求数 |
| `RATE_LIMIT_WINDOW` | `900000` | 速率限制时间窗口(毫秒) |
| `CORS_ORIGIN` | `*` | CORS允许的源 |
| `COOKIE_SECURE` | `true` | Cookie安全标志 |
| `COOKIE_SAME_SITE` | `lax` | Cookie SameSite策略 |

#### 日志和监控配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `LOG_LEVEL` | `info` | 日志级别 |
| `ENABLE_REQUEST_LOGGING` | `false` | 启用请求日志 |
| `SENTRY_DSN` | - | Sentry错误监控DSN |
| `ANALYTICS_ID` | - | 分析服务ID |

#### 开发配置
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `ENABLE_DEBUG` | `false` | 启用调试模式 |
| `MOCK_FEISHU_API` | `false` | 模拟飞书API |
| `SKIP_AUTH_IN_DEV` | `false` | 开发环境跳过认证 |

## 🚀 快速配置指南

### 1. 本地开发环境

```bash
# 1. 复制环境变量模板
cp .env.example .env.local

# 2. 配置必需变量
# 编辑 .env.local 文件，至少配置以下变量：
# - FEISHU_APP_ID
# - FEISHU_APP_SECRET  
# - FEISHU_REDIRECT_URI
# - ENCRYPTION_KEY
# - JWT_SECRET
# - NEXT_PUBLIC_APP_URL

# 3. 生成加密密钥
openssl rand -hex 32  # 用于 ENCRYPTION_KEY
openssl rand -base64 32  # 用于 JWT_SECRET
```

### 2. 生产环境（Vercel）

```bash
# 1. 在Vercel控制台设置环境变量
# 2. 创建必需的存储服务：
#    - Postgres数据库
#    - KV Redis缓存  
#    - Blob文件存储
# 3. 配置OCR服务（推荐Gemini）
```

## 🔧 详细配置说明

### 飞书开放平台配置

1. **创建应用**
   - 访问 [飞书开放平台](https://open.feishu.cn/)
   - 创建企业自建应用
   - 获取 App ID 和 App Secret

2. **配置权限**
   - 申请云文档读写权限
   - 申请用户基本信息权限
   - 设置OAuth回调地址

3. **回调地址设置**
   ```
   开发环境: http://localhost:3000/api/auth/callback
   生产环境: https://your-domain.com/api/auth/callback
   ```

### Vercel存储服务配置

1. **Postgres数据库**
   ```bash
   # Vercel控制台操作
   1. 进入项目设置
   2. Storage -> Create Database -> Postgres
   3. 复制生成的环境变量到项目配置
   ```

2. **KV Redis缓存**
   ```bash
   # 用于存储会话和缓存数据
   1. Storage -> Create Database -> KV
   2. 复制KV_REST_API_URL和KV_REST_API_TOKEN
   ```

3. **Blob文件存储**
   ```bash
   # 用于存储上传的截图文件
   1. Storage -> Create Database -> Blob
   2. 复制BLOB_READ_WRITE_TOKEN
   ```

### OCR服务配置

#### 推荐：Google Gemini Vision API

```bash
# 1. 访问 Google AI Studio
# 2. 创建API密钥
# 3. 设置环境变量
GOOGLE_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-1.5-flash
```

**优势：**
- 免费额度充足
- 识别准确率高
- 支持中文识别
- 集成简单

## ⚠️ 安全注意事项

1. **密钥管理**
   - 永远不要将密钥提交到代码仓库
   - 使用强随机密钥
   - 定期轮换密钥

2. **生产环境**
   - 使用HTTPS
   - 启用Cookie安全标志
   - 配置正确的CORS策略

3. **访问控制**
   - 限制API访问频率
   - 验证用户权限
   - 记录操作日志

## 🔍 故障排除

### 常见问题

1. **飞书认证失败**
   - 检查App ID和Secret是否正确
   - 确认回调地址配置正确
   - 验证应用权限是否申请

2. **数据库连接失败**
   - 检查DATABASE_URL格式
   - 确认数据库服务状态
   - 验证网络连接

3. **OCR功能异常**
   - 检查API密钥是否有效
   - 确认服务配额是否充足
   - 验证图片格式和大小

### 环境变量验证

项目启动时会自动验证必需的环境变量，如有缺失会显示详细的错误信息和配置指导。
